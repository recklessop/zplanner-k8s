apiVersion: batch/v1
kind: Job
metadata:
  name: influxdb-setup
spec:
  template:
    spec:
      containers:
        - name: influxdb-setup
          image: influxdb:2.0
          command: ["/bin/bash", "/setup/setup.sh"]
          volumeMounts:
            - name: setup-script
              mountPath: /setup
            - name: shared-data
              mountPath: /shared
        - name: json-parser
          image: bitnami/minideb
          command: ["bash", "-c", "apt-get update && apt-get install -y jq && while [ ! -f /shared/setup_output.json ]; do echo 'Waiting for setup output...'; sleep 5; done; TOKEN=$(cat /shared/setup_output.json | jq -r '.auth.token'); echo $TOKEN > /shared/token.txt; echo 'Token extracted and written to /shared/token.txt'"]
          volumeMounts:
            - name: shared-data
              mountPath: /shared
      volumes:
        - name: setup-script
          configMap:
            name: influxdb-setup-script
        - name: shared-data
          emptyDir: {}
      restartPolicy: OnFailure
